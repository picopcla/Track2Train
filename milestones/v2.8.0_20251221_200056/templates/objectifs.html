<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objectifs - Track2Train</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .nav {
            margin-top: 20px;
        }

        .nav a {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-right: 10px;
            transition: background 0.3s;
        }

        .nav a:hover {
            background: #764ba2;
        }

        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #2196f3;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #555;
            line-height: 1.6;
        }

        .objectives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .objective-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .objective-card h2 {
            color: #333;
            margin-bottom: 5px;
            font-size: 20px;
        }

        .objective-card .description {
            color: #999;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .stat-value.current {
            color: #2196f3;
            font-size: 24px;
        }

        .stat-value.suggested {
            color: #4caf50;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #4caf50;
            color: white;
        }

        .btn-secondary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-summary {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .stats-summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }

        .stat-box .label {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-box .value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 768px) {
            .objectives-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Gestion des Objectifs</h1>
            <p class="subtitle">Configuration des objectifs personnalis√©s par type de run</p>

            <div class="nav">
                <a href="/">‚Üê Retour au Dashboard</a>
                <a href="/profile">Profil</a>
            </div>
        </div>

        <div class="info-box">
            <h3>üìñ Comment √ßa marche ?</h3>
            <p>
                <strong>Efficacit√© cardiaque (k)</strong> : Plus BAS = meilleur (FC basse pour une allure donn√©e)<br>
                <strong>D√©rive cardiaque (drift)</strong> : Proche de 1.0 = excellent (FC stable pendant l'effort)<br><br>
                <strong>Recalcul automatique (approche coach sportif)</strong> :<br>
                ‚Ä¢ k: P30 (30% de vos meilleurs runs) = ambitieux mais atteignable<br>
                ‚Ä¢ drift: P40 (40%) + planchers physiologiques = r√©aliste et motivant<br>
                ‚Ä¢ Les planchers √©vitent les objectifs irr√©alistes (ex: drift < 1.03 est rare physiologiquement)
            </p>
        </div>

        {% if stats_by_type %}
        <div class="stats-summary">
            <h3>üìä Vue d'ensemble</h3>
            <div class="stats-grid">
                {% for cat, stats in stats_by_type.items() %}
                <div class="stat-box">
                    <div class="label">{{ cat|replace('_', ' ')|title }}</div>
                    <div class="value">{{ stats.count }} runs</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="objectives-grid">
            {% for run_type in ['tempo_recup', 'tempo_rapide', 'endurance', 'long_run'] %}
            {% set current = profile.get('personalized_targets', {}).get(run_type, {}) %}
            {% set stats = stats_by_type.get(run_type, {}) %}

            <div class="objective-card">
                <h2>{{ run_type|replace('_', ' ')|title }}</h2>
                <p class="description">
                    {% if run_type == 'tempo_recup' %}
                    Runs courts (‚â§6.5km) √† allure r√©cup√©ration (‚â•5:30/km)
                    {% elif run_type == 'tempo_rapide' %}
                    Runs courts (‚â§6.5km) √† allure rapide (<5:30/km)
                    {% elif run_type == 'endurance' %}
                    Runs moyens (6.5-12km)
                    {% elif run_type == 'long_run' %}
                    Runs longs (>12km)
                    {% endif %}
                </p>

                {% if stats.get('count', 0) > 0 %}
                <div class="stat-row">
                    <span class="stat-label">Nombre de runs</span>
                    <span class="stat-value">{{ stats.count }}</span>
                </div>

                {% if stats.get('k_mean') %}
                <div class="stat-row">
                    <span class="stat-label">K moyen</span>
                    <span class="stat-value">{{ "%.2f"|format(stats.k_mean) }}</span>
                </div>

                <div class="stat-row">
                    <span class="stat-label">K sugg√©r√© (P20)</span>
                    <span class="stat-value suggested">{{ "%.2f"|format(stats.k_p20) }}</span>
                </div>
                {% endif %}

                {% if stats.get('drift_mean') %}
                <div class="stat-row">
                    <span class="stat-label">Drift moyen</span>
                    <span class="stat-value">{{ "%.2f"|format(stats.drift_mean) }}</span>
                </div>

                <div class="stat-row">
                    <span class="stat-label">Drift sugg√©r√© (P20)</span>
                    <span class="stat-value suggested">{{ "%.2f"|format(stats.drift_p20) }}</span>
                </div>
                {% endif %}

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

                <div class="input-group">
                    <label for="k_target_{{ run_type }}">Objectif K</label>
                    <input type="number"
                           id="k_target_{{ run_type }}"
                           step="0.01"
                           value="{{ current.get('k_target', '') }}"
                           placeholder="Ex: 4.20">
                </div>

                <div class="input-group">
                    <label for="drift_target_{{ run_type }}">Objectif Drift</label>
                    <input type="number"
                           id="drift_target_{{ run_type }}"
                           step="0.01"
                           value="{{ current.get('drift_target', '') }}"
                           placeholder="Ex: 1.05">
                </div>

                {% else %}
                <p style="color: #999; text-align: center; padding: 20px;">Aucun run de ce type encore</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="saveObjectives()">üíæ Sauvegarder</button>
            <button class="btn btn-secondary" onclick="recalculateObjectives()">üîÑ Recalculer (P20)</button>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        async function saveObjectives() {
            const data = {};

            ['tempo_recup', 'tempo_rapide', 'endurance', 'long_run'].forEach(type => {
                const k = document.getElementById(`k_target_${type}`).value;
                const drift = document.getElementById(`drift_target_${type}`).value;

                if (k && drift) {
                    data[type] = {
                        k_target: parseFloat(k),
                        drift_target: parseFloat(drift)
                    };
                }
            });

            try {
                const response = await fetch('/api/objectifs/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('success', '‚úÖ Objectifs sauvegard√©s avec succ√®s !');
                } else {
                    showMessage('error', '‚ùå Erreur: ' + result.error);
                }
            } catch (error) {
                showMessage('error', '‚ùå Erreur de connexion: ' + error.message);
            }
        }

        async function recalculateObjectives() {
            if (!confirm('Recalculer automatiquement les objectifs bas√©s sur vos 20% meilleurs runs ?')) {
                return;
            }

            try {
                const response = await fetch('/api/objectifs/recalculate', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('success', '‚úÖ ' + result.message + ' - Rechargement...');

                    // Update inputs with new values
                    Object.keys(result.targets).forEach(type => {
                        const target = result.targets[type];
                        document.getElementById(`k_target_${type}`).value = target.k_target;
                        document.getElementById(`drift_target_${type}`).value = target.drift_target;
                    });

                    // Reload after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showMessage('error', '‚ùå Erreur: ' + result.error);
                }
            } catch (error) {
                showMessage('error', '‚ùå Erreur de connexion: ' + error.message);
            }
        }

        function showMessage(type, text) {
            const messageEl = document.getElementById('message');
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
